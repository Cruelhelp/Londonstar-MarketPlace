<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Orders - London Star Marketplace</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="css/main.css">
    <!-- Premium Design System -->
    <link rel="stylesheet" href="css/premium-design.css">
    <link rel="stylesheet" href="css/animations.css">
    <link rel="stylesheet" href="css/skeleton.css">
    <style>
        .orders-page {
            min-height: 100vh;
            background: #f5f5f5;
        }

        .orders-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .page-header {
            margin-bottom: 40px;
        }

        .page-header h1 {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 8px;
        }

        .page-header p {
            color: #6b7280;
            font-size: 16px;
        }

        .orders-tabs {
            display: flex;
            gap: 16px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e5e7eb;
        }

        .tab-btn {
            padding: 12px 24px;
            background: none;
            border: none;
            font-size: 15px;
            font-weight: 600;
            color: #6b7280;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
        }

        .tab-btn:hover {
            color: var(--accent-color);
        }

        .orders-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .order-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .order-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .order-info {
            flex: 1;
        }

        .order-number {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 8px;
        }

        .order-date {
            font-size: 14px;
            color: #6b7280;
        }

        .order-status {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .order-status.pending {
            background: #fef3c7;
            color: #92400e;
        }

        .order-status.processing {
            background: #dbeafe;
            color: #1e40af;
        }

        .order-status.completed {
            background: #d1fae5;
            color: #065f46;
        }

        .order-status.cancelled {
            background: #fee2e2;
            color: #991b1b;
        }

        .order-items {
            margin-bottom: 20px;
        }

        .order-item {
            display: flex;
            gap: 16px;
            padding: 12px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .order-item:last-child {
            border-bottom: none;
        }

        .item-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            background: #f3f4f6;
        }

        .item-details {
            flex: 1;
        }

        .item-name {
            font-size: 15px;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 4px;
        }

        .item-meta {
            font-size: 14px;
            color: #6b7280;
        }

        .item-price {
            font-size: 16px;
            font-weight: 700;
            color: var(--accent-color);
        }

        .order-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }

        .order-total {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-color);
        }

        .order-actions {
            display: flex;
            gap: 12px;
        }

        .btn-view {
            padding: 10px 20px;
            background: white;
            border: 2px solid var(--accent-color);
            color: var(--accent-color);
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-view:hover {
            background: var(--accent-color);
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
        }

        .empty-state svg {
            margin: 0 auto 20px;
            color: #d1d5db;
        }

        .empty-state h3 {
            font-size: 20px;
            font-weight: 600;
            color: #4b5563;
            margin-bottom: 8px;
        }

        .empty-state p {
            color: #9ca3af;
            margin-bottom: 24px;
        }

        @media (max-width: 768px) {
            .orders-container {
                padding: 20px 16px;
            }

            .page-header h1 {
                font-size: 24px;
            }

            .orders-tabs {
                gap: 8px;
            }

            .tab-btn {
                padding: 10px 16px;
                font-size: 14px;
            }

            .order-header {
                flex-direction: column;
                gap: 12px;
            }

            .order-footer {
                flex-direction: column;
                gap: 16px;
                align-items: stretch;
            }

            .order-actions {
                flex-direction: column;
            }

            .btn-view {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-spinner"></div>
    </div>

    <div class="orders-page">
        <!-- Header -->
        <header class="header">
            <div class="header-main">
                <div class="logo-container" onclick="window.location.href='index.html'">
                    <img src="images/logo-icon-new.svg" alt="London Marketplace" style="width: 60px; height: 60px;">
                </div>
                <div class="search-bar">
                    <input type="text" id="globalSearchInput" placeholder="Search for products..." onkeypress="handleSearch(event)">
                    <button onclick="performSearch()">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                    </button>
                </div>
                <nav class="header-nav" id="headerNav">
                    <!-- Navigation will be loaded here -->
                </nav>
            </div>
        </header>

        <!-- Main Content -->
        <div class="orders-container">
            <div class="page-header">
                <h1>My Orders</h1>
                <p>Track and manage your orders</p>
            </div>

            <!-- Order Status Tabs -->
            <div class="orders-tabs">
                <button class="tab-btn active" onclick="filterOrders('all')">All Orders</button>
                <button class="tab-btn" onclick="filterOrders('pending')">Pending</button>
                <button class="tab-btn" onclick="filterOrders('processing')">Processing</button>
                <button class="tab-btn" onclick="filterOrders('completed')">Completed</button>
            </div>

            <!-- Orders List -->
            <div class="orders-list" id="ordersList">
                <!-- Orders will be loaded here -->
            </div>

            <!-- Empty State -->
            <div class="empty-state" id="emptyState" style="display: none;">
                <svg width="120" height="120" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                    <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                <h3>No orders yet</h3>
                <p>Start shopping to see your orders here</p>
                <a href="marketplace.html" class="btn btn-primary">Browse Products</a>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/session-manager.js"></script>

    <!-- Security & Validation -->
    <script src="js/security.js"></script>
    <script src="js/dom-builder.js"></script>

    <script>
        // Use global sessionManager and supabase from their respective files
        let allOrders = [];
        let currentFilter = 'all';

        // Check authentication
        const userId = localStorage.getItem('userId') || sessionStorage.getItem('userId');
        if (!userId) {
            window.location.href = 'auth.html';
        }

        // Load orders on page load
        window.addEventListener('load', async () => {
            await loadHeaderNav();
            await loadOrders();
            setTimeout(() => {
                document.getElementById('loadingScreen').classList.add('hidden');
            }, 1000);
        });

        // Load header navigation
        async function loadHeaderNav() {
            const userEmail = localStorage.getItem('userEmail') || sessionStorage.getItem('userEmail');
            const userName = localStorage.getItem('userName') || sessionStorage.getItem('userName');
            const userRole = localStorage.getItem('userRole');
            const headerNav = document.getElementById('headerNav');

            const displayName = userName || userEmail?.split('@')[0] || 'User';

            headerNav.innerHTML = `
                <span class="nav-link" style="color: var(--accent-color); font-weight: 600; pointer-events: none; display: flex; flex-direction: column; align-items: flex-start;">
                    <span style="font-size: 11px; font-weight: 400;">Welcome</span>
                    <span style="font-size: 13px; font-weight: 600;">${displayName}</span>
                </span>
                <a href="marketplace.html" class="nav-link" style="display: flex; flex-direction: column; align-items: flex-start;">
                    <span style="font-size: 11px; font-weight: 400;">Browse</span>
                    <span style="font-size: 13px; font-weight: 600;">Products</span>
                </a>
                <a href="orders.html" class="nav-link" style="display: flex; flex-direction: column; align-items: flex-start;">
                    <span style="font-size: 11px; font-weight: 400;">My</span>
                    <span style="font-size: 13px; font-weight: 600;">Orders</span>
                </a>
                <a href="profile.html" class="nav-link" style="display: flex; flex-direction: column; align-items: flex-start;">
                    <span style="font-size: 11px; font-weight: 400;">My</span>
                    <span style="font-size: 13px; font-weight: 600;">Profile</span>
                </a>
                <a href="cart.html" class="nav-icon-btn">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="9" cy="21" r="1"/>
                        <circle cx="20" cy="21" r="1"/>
                        <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
                    </svg>
                    <span style="font-size: 12px; font-weight: 600;">Cart</span>
                </a>
                <button class="nav-icon-btn" onclick="handleLogout()" style="background: transparent; border: none; cursor: pointer;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                    <span style="font-size: 12px; font-weight: 500;">Logout</span>
                </button>
            `;
        }

        // Handle logout
        async function handleLogout() {
            try {
                // Clear session data
                sessionManager.clearSession();

                // Sign out from Supabase
                const { error } = await supabase.auth.signOut();
                if (error) console.error('Logout error:', error);

                // Clear all user-related data
                localStorage.removeItem('userId');
                localStorage.removeItem('userEmail');
                localStorage.removeItem('userName');
                localStorage.removeItem('userRole');
                localStorage.removeItem('isAdmin');
                sessionStorage.clear();

                // Prevent back button by replacing history
                window.location.replace('index.html');
            } catch (error) {
                console.error('Error during logout:', error);
                // Still redirect even if there's an error
                sessionManager.clearSession();
                localStorage.clear();
                sessionStorage.clear();
                window.location.replace('index.html');
            }
        }

        // Load orders from Supabase
        async function loadOrders() {
            try {
                const { data: orders, error } = await supabase
                    .from('orders')
                    .select('*')
                    .eq('buyer_id', userId)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                allOrders = orders || [];
                renderOrders();

            } catch (error) {
                console.error('Error loading orders:', error);
                showAlert('Error loading orders', 'error');
            }
        }

        // Render orders
        function renderOrders() {
            const ordersList = document.getElementById('ordersList');
            const emptyState = document.getElementById('emptyState');

            const filteredOrders = currentFilter === 'all'
                ? allOrders
                : allOrders.filter(order => order.status === currentFilter);

            if (filteredOrders.length === 0) {
                ordersList.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            ordersList.style.display = 'flex';
            emptyState.style.display = 'none';

            // Clear orders list safely
            ordersList.textContent = '';

            // Render orders using safe DOM manipulation
            filteredOrders.forEach(order => {
                const orderCard = DOMBuilder.div({ className: 'order-card' });

                // Order header
                const orderHeader = DOMBuilder.div({ className: 'order-header' });

                const orderInfo = DOMBuilder.div({ className: 'order-info' });

                // Order number (SAFE - textContent prevents XSS)
                const orderNumber = DOMBuilder.div({
                    className: 'order-number',
                    text: `Order #${order.id.slice(0, 8).toUpperCase()}`
                });
                orderInfo.appendChild(orderNumber);

                // Order date
                const orderDate = DOMBuilder.div({
                    className: 'order-date',
                    text: `Placed on ${new Date(order.created_at).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}`
                });
                orderInfo.appendChild(orderDate);

                orderHeader.appendChild(orderInfo);

                // Order status (SAFE - textContent prevents XSS)
                const orderStatus = document.createElement('span');
                orderStatus.className = `order-status ${order.status}`;
                orderStatus.textContent = order.status.toUpperCase();
                orderHeader.appendChild(orderStatus);

                orderCard.appendChild(orderHeader);

                // Order items
                const orderItems = DOMBuilder.div({ className: 'order-items' });
                renderOrderItems(order, orderItems);
                orderCard.appendChild(orderItems);

                // Order footer
                const orderFooter = DOMBuilder.div({ className: 'order-footer' });

                const orderTotal = DOMBuilder.div({
                    className: 'order-total',
                    text: `Total: $${parseFloat(order.total || 0).toFixed(2)}`
                });
                orderFooter.appendChild(orderTotal);

                const orderActions = DOMBuilder.div({ className: 'order-actions' });
                const viewBtn = DOMBuilder.button({
                    className: 'btn-view',
                    text: 'View Details',
                    onClick: () => viewOrderDetails(order.id)
                });
                orderActions.appendChild(viewBtn);

                orderFooter.appendChild(orderActions);
                orderCard.appendChild(orderFooter);

                ordersList.appendChild(orderCard);
            });
        }

        // Render order items (SAFE - now appends DOM elements)
        function renderOrderItems(order, container) {
            // Parse items JSONB array
            let items = order.items || [];

            // Handle if items is a string (needs parsing)
            if (typeof items === 'string') {
                try {
                    items = JSON.parse(items);
                } catch (e) {
                    console.error('Error parsing order items:', e);
                    const errorMsg = DOMBuilder.div({
                        className: 'item-meta',
                        text: 'Order details unavailable'
                    });
                    container.appendChild(errorMsg);
                    return;
                }
            }

            if (!Array.isArray(items) || items.length === 0) {
                const noItems = DOMBuilder.div({
                    className: 'item-meta',
                    text: 'No items in this order'
                });
                container.appendChild(noItems);
                return;
            }

            // Render all items in the order
            items.forEach(item => {
                const images = typeof item.images === 'string' ? JSON.parse(item.images) : item.images;
                const firstImage = Array.isArray(images) && images.length > 0 ? images[0] : '';

                const orderItem = DOMBuilder.div({ className: 'order-item' });

                // Item image
                const img = DOMBuilder.img({
                    attrs: {
                        src: firstImage || 'images/placeholder.png',
                        alt: item.name || 'Product'  // SAFE - alt attribute
                    },
                    className: 'item-image'
                });
                orderItem.appendChild(img);

                // Item details
                const itemDetails = DOMBuilder.div({ className: 'item-details' });

                // Item name (SAFE - textContent prevents XSS)
                const itemName = DOMBuilder.div({
                    className: 'item-name',
                    text: item.name || 'Product'
                });
                itemDetails.appendChild(itemName);

                // Item quantity
                const itemMeta = DOMBuilder.div({
                    className: 'item-meta',
                    text: `Quantity: ${item.quantity || 1}`
                });
                itemDetails.appendChild(itemMeta);

                orderItem.appendChild(itemDetails);

                // Item price
                const itemPrice = DOMBuilder.div({
                    className: 'item-price',
                    text: `J$${parseFloat(item.price || 0).toFixed(2)}`
                });
                orderItem.appendChild(itemPrice);

                container.appendChild(orderItem);
            });
        }

        // Filter orders by status
        function filterOrders(status) {
            currentFilter = status;

            // Update active tab
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            renderOrders();
        }

        // View order details
        function viewOrderDetails(orderId) {
            // Navigate to order detail page or show modal
            alert(`Order details for ${orderId} - Feature coming soon!`);
        }

        // Search functionality
        function handleSearch(event) {
            if (event.key === 'Enter') {
                performSearch();
            }
        }

        function performSearch() {
            const query = document.getElementById('globalSearchInput').value;
            if (query) {
                window.location.href = `marketplace.html?search=${encodeURIComponent(query)}`;
            }
        }

        // Alert function
        function showAlert(message, type = 'info') {
            alert(message);
        }
    </script>

    <!-- Premium UI Components -->
    <script src="js/skeleton-loader.js"></script>
    <script src="js/rating-component.js"></script>
    <script src="js/ripple.js"></script>

    <!-- Vercel Analytics -->
    <script defer src="/_vercel/insights/script.js"></script>
</body>
</html>
