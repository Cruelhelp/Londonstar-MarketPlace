<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <title>Admin Panel - London Marketplace</title>
    <link rel="stylesheet" href="css/main.css">
    <style>
        .admin-sidebar {
            position: fixed;
            left: 0;
            top: 70px;
            width: 250px;
            height: calc(100vh - 70px);
            background: var(--primary-color);
            padding: 20px;
            overflow-y: auto;
        }

        .admin-nav-item {
            display: block;
            color: white;
            text-decoration: none;
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 6px;
            transition: background 0.2s ease;
            cursor: pointer;
        }

        .admin-nav-item:hover, .admin-nav-item.active {
            background: var(--accent-color);
            color: var(--text-primary);
        }

        .admin-content {
            margin-left: 250px;
            padding: 20px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .data-table {
            width: 100%;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .data-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: var(--secondary-color);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .data-table tr:hover {
            background: var(--bg-light);
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .loading-row {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 13px;
        }

        @media (max-width: 768px) {
            .admin-sidebar {
                width: 100%;
                position: relative;
                top: 0;
                height: auto;
            }

            .admin-content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-main">
            <div class="logo-container" onclick="confirmLeave('home.html')">
                <img src="images/logo-icon-new.svg" alt="London Marketplace">
            </div>
            <div style="flex: 1; padding-left: 20px;">
                <span style="color: white; font-size: 18px; font-weight: 600;">Admin Panel</span>
            </div>
            <nav class="header-nav">
                <a href="#" onclick="confirmLeave('marketplace.html'); return false;" class="nav-link">View Marketplace</a>
                <a href="#" class="nav-link" onclick="handleLogout(); return false;">Sign Out</a>
            </nav>
        </div>
    </header>

    <!-- Admin Sidebar -->
    <div class="admin-sidebar">
        <div class="admin-nav-item active" onclick="switchTab('dashboard')">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 10px;">
                <rect x="3" y="3" width="7" height="7"/>
                <rect x="14" y="3" width="7" height="7"/>
                <rect x="14" y="14" width="7" height="7"/>
                <rect x="3" y="14" width="7" height="7"/>
            </svg>
            Dashboard
        </div>
        <div class="admin-nav-item" onclick="switchTab('products')">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 10px;">
                <path d="M20 7H4c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V9c0-1.1-.9-2-2-2z"/>
            </svg>
            Products
        </div>
        <div class="admin-nav-item" onclick="switchTab('users')">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 10px;">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>
            Users
        </div>
        <div class="admin-nav-item" onclick="switchTab('sellers')">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 10px;">
                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
                <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                <circle cx="16" cy="7" r="2"/>
            </svg>
            Seller Approvals
        </div>
        <div class="admin-nav-item" onclick="switchTab('orders')">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 10px;">
                <circle cx="9" cy="21" r="1"/>
                <circle cx="20" cy="21" r="1"/>
                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
            </svg>
            Orders
        </div>
        <a href="#" onclick="confirmLeave('admin-cards.html'); return false;" class="admin-nav-item" style="text-decoration: none;">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 10px;">
                <rect x="3" y="3" width="7" height="7" rx="1"/>
                <rect x="14" y="3" width="7" height="7" rx="1"/>
                <rect x="3" y="14" width="7" height="7" rx="1"/>
                <rect x="14" y="14" width="7" height="7" rx="1"/>
            </svg>
            Homepage Cards
        </a>
        <div class="admin-nav-item" onclick="switchTab('settings')">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 10px;">
                <circle cx="12" cy="12" r="3"/>
                <path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24"/>
            </svg>
            Settings
        </div>
    </div>

    <!-- Admin Content -->
    <div class="admin-content">
        <!-- Dashboard Tab -->
        <div class="tab-content active" id="dashboard">
            <h1 style="margin-bottom: 30px;">Dashboard Overview</h1>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalUsers">0</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalProducts">0</div>
                    <div class="stat-label">Total Products</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalOrders">0</div>
                    <div class="stat-label">Total Orders</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">$<span id="totalRevenue">0.00</span></div>
                    <div class="stat-label">Total Revenue</div>
                </div>
            </div>

            <div class="grid grid-2 mt-20">
                <div class="card">
                    <h3>Recent Activity</h3>
                    <div id="recentActivity" style="margin-top: 20px; color: var(--text-secondary);">
                        <p>No recent activity</p>
                    </div>
                </div>
                <div class="card">
                    <h3>Quick Actions</h3>
                    <div style="margin-top: 20px;">
                        <button class="btn btn-primary" style="width: 100%; margin-bottom: 10px;" onclick="switchTab('products')">Manage Products</button>
                        <button class="btn btn-secondary" style="width: 100%; margin-bottom: 10px;" onclick="switchTab('users')">Manage Users</button>
                        <button class="btn btn-secondary" style="width: 100%;" onclick="switchTab('orders')">View Orders</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Products Tab -->
        <div class="tab-content" id="products">
            <h1 style="margin-bottom: 30px;">Product Management</h1>
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Category</th>
                            <th>Price</th>
                            <th>Stock</th>
                            <th>Seller</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="productsTableBody">
                        <tr>
                            <td colspan="7" class="loading-row">Loading products...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Users Tab -->
        <div class="tab-content" id="users">
            <h1 style="margin-bottom: 30px;">User Management</h1>
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Full Name</th>
                            <th>Role</th>
                            <th>Created Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <tr>
                            <td colspan="5" class="loading-row">Loading users...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Seller Approvals Tab -->
        <div class="tab-content" id="sellers">
            <h1 style="margin-bottom: 30px;">Seller Account Approvals</h1>
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Full Name</th>
                            <th>Status</th>
                            <th>Created Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="sellersTableBody">
                        <tr>
                            <td colspan="5" class="loading-row">Loading pending sellers...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Orders Tab -->
        <div class="tab-content" id="orders">
            <h1 style="margin-bottom: 30px;">Order Management</h1>
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Buyer</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTableBody">
                        <tr>
                            <td colspan="6" class="loading-row">Loading orders...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Settings Tab -->
        <div class="tab-content" id="settings">
            <h1 style="margin-bottom: 30px;">Platform Settings</h1>
            <div class="card">
                <h3>General Settings</h3>
                <form id="settingsForm" style="margin-top: 20px;">
                    <div class="form-group">
                        <label>Platform Name</label>
                        <input type="text" id="platformName" required>
                    </div>
                    <div class="form-group">
                        <label>Platform Email</label>
                        <input type="email" id="platformEmail" required>
                    </div>
                    <div class="form-group">
                        <label>Commission Rate (%)</label>
                        <input type="number" id="commissionRate" min="0" max="100" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Currency</label>
                        <select id="currency" required>
                            <option value="USD">USD - US Dollar</option>
                            <option value="GBP">GBP - British Pound</option>
                            <option value="EUR">EUR - Euro</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary" id="saveSettingsBtn">Save Settings</button>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/supabase-init.js"></script>
    <script src="js/session-manager.js"></script>
    <script>
        // ============================================
        // ADMIN SESSION PROTECTION
        // ============================================

        // Check if user has admin role on page load
        const isAdmin = localStorage.getItem('isAdmin') === 'true';
        const userRole = localStorage.getItem('userRole');

        if (!isAdmin && userRole !== 'admin') {
            alert('Access denied. Admin privileges required.');
            window.location.href = 'index.html';
        }

        // ============================================
        // NAVIGATION CONFIRMATION DIALOGS
        // ============================================

        function confirmLeave(url) {
            if (confirm('Are you sure you want to leave the admin panel?')) {
                window.location.href = url;
            }
        }

        // ============================================
        // SUPABASE CLIENT REFERENCE
        // ============================================

        const supabase = window.supabaseClient;

        // ============================================
        // TAB SWITCHING
        // ============================================

        function switchTab(tabName, event) {
            // Update nav items
            document.querySelectorAll('.admin-nav-item').forEach(item => {
                item.classList.remove('active');
            });

            // Find the nav item that was clicked (could be the element itself or a parent)
            if (event) {
                let navItem = event.target;
                while (navItem && !navItem.classList.contains('admin-nav-item')) {
                    navItem = navItem.parentElement;
                }
                if (navItem) {
                    navItem.classList.add('active');
                }
            }

            // Update content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');

            // Load data for the tab
            if (tabName === 'dashboard') loadDashboard();
            if (tabName === 'products') loadProducts();
            if (tabName === 'users') loadUsers();
            if (tabName === 'sellers') loadSellers();
            if (tabName === 'orders') loadOrders();
            if (tabName === 'settings') loadSettings();
        }

        // ============================================
        // DASHBOARD SECTION
        // ============================================

        async function loadDashboard() {
            try {
                // Get total users count
                const { count: usersCount, error: usersError } = await supabase
                    .from('users')
                    .select('*', { count: 'exact', head: true });

                if (usersError) throw usersError;

                // Get total products count
                const { count: productsCount, error: productsError } = await supabase
                    .from('products')
                    .select('*', { count: 'exact', head: true });

                if (productsError) throw productsError;

                // Get total orders count
                const { count: ordersCount, error: ordersError } = await supabase
                    .from('orders')
                    .select('*', { count: 'exact', head: true });

                if (ordersError) throw ordersError;

                // Get total revenue
                const { data: orders, error: revenueError } = await supabase
                    .from('orders')
                    .select('total');

                if (revenueError) throw revenueError;

                const totalRevenue = orders.reduce((sum, order) => sum + parseFloat(order.total || 0), 0);

                // Update dashboard stats
                document.getElementById('totalUsers').textContent = usersCount || 0;
                document.getElementById('totalProducts').textContent = productsCount || 0;
                document.getElementById('totalOrders').textContent = ordersCount || 0;
                document.getElementById('totalRevenue').textContent = totalRevenue.toFixed(2);

            } catch (error) {
                console.error('Error loading dashboard:', error);
                alert('Error loading dashboard statistics: ' + error.message);
            }
        }

        // ============================================
        // PRODUCTS SECTION
        // ============================================

        async function loadProducts() {
            const tbody = document.getElementById('productsTableBody');
            tbody.innerHTML = '<tr><td colspan="7" class="loading-row">Loading products...</td></tr>';

            try {
                const { data: products, error } = await supabase
                    .from('products')
                    .select(`
                        id,
                        name,
                        category,
                        price,
                        stock,
                        status,
                        seller_id,
                        users!products_seller_id_fkey (
                            email,
                            full_name
                        )
                    `)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (!products || products.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-secondary);">No products found</td></tr>';
                    return;
                }

                tbody.innerHTML = products.map(product => `
                    <tr>
                        <td>${product.id.substring(0, 8)}...</td>
                        <td>${product.name}</td>
                        <td>${product.category}</td>
                        <td>$${parseFloat(product.price).toFixed(2)}</td>
                        <td>${product.stock}</td>
                        <td>${product.users?.email || 'Unknown'}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-secondary btn-sm" onclick="editStock('${product.id}', ${product.stock})">Edit Stock</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteProduct('${product.id}')">Delete</button>
                            </div>
                        </td>
                    </tr>
                `).join('');

            } catch (error) {
                console.error('Error loading products:', error);
                tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; color: red;">Error loading products: ${error.message}</td></tr>`;
            }
        }

        async function editStock(productId, currentStock) {
            const newStock = prompt(`Enter new stock quantity (current: ${currentStock}):`, currentStock);

            if (newStock === null) return; // User cancelled

            const stockValue = parseInt(newStock);
            if (isNaN(stockValue) || stockValue < 0) {
                alert('Please enter a valid stock quantity (0 or greater)');
                return;
            }

            try {
                const { error } = await supabase
                    .from('products')
                    .update({ stock: stockValue })
                    .eq('id', productId);

                if (error) throw error;

                alert('Stock updated successfully!');
                loadProducts();
                loadDashboard(); // Refresh dashboard stats

            } catch (error) {
                console.error('Error updating stock:', error);
                alert('Error updating stock: ' + error.message);
            }
        }

        async function deleteProduct(productId) {
            if (!confirm('Are you sure you want to delete this product? This action cannot be undone.')) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('products')
                    .delete()
                    .eq('id', productId);

                if (error) throw error;

                alert('Product deleted successfully!');
                loadProducts();
                loadDashboard(); // Refresh dashboard stats

            } catch (error) {
                console.error('Error deleting product:', error);
                alert('Error deleting product: ' + error.message);
            }
        }

        // ============================================
        // USERS SECTION
        // ============================================

        async function loadUsers() {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '<tr><td colspan="5" class="loading-row">Loading users...</td></tr>';

            try {
                const { data: users, error } = await supabase
                    .from('users')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (!users || users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-secondary);">No users found</td></tr>';
                    return;
                }

                tbody.innerHTML = users.map(user => {
                    const roleClass = user.role === 'admin' ? 'badge-danger' :
                                     user.role === 'seller' ? 'badge-warning' : 'badge-success';
                    const createdDate = new Date(user.created_at).toLocaleDateString();

                    return `
                        <tr>
                            <td>${user.email}</td>
                            <td>${user.full_name || 'N/A'}</td>
                            <td><span class="badge ${roleClass}">${user.role}</span></td>
                            <td>${createdDate}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-secondary btn-sm" onclick="changeUserRole('${user.id}', '${user.role}')">Change Role</button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteUser('${user.id}')">Delete</button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading users:', error);
                tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: red;">Error loading users: ${error.message}</td></tr>`;
            }
        }

        async function changeUserRole(userId, currentRole) {
            const roles = ['buyer', 'seller', 'admin'];
            const roleChoice = prompt(`Select new role:\n1 = buyer\n2 = seller\n3 = admin\n\nCurrent role: ${currentRole}`);

            if (!roleChoice) return; // User cancelled

            const roleIndex = parseInt(roleChoice) - 1;
            if (roleIndex < 0 || roleIndex > 2) {
                alert('Invalid choice. Please enter 1, 2, or 3.');
                return;
            }

            const newRole = roles[roleIndex];

            try {
                const { error } = await supabase
                    .from('users')
                    .update({ role: newRole })
                    .eq('id', userId);

                if (error) throw error;

                alert(`User role changed to ${newRole} successfully!`);
                loadUsers();

            } catch (error) {
                console.error('Error changing user role:', error);
                alert('Error changing user role: ' + error.message);
            }
        }

        // Load pending sellers
        async function loadSellers() {
            const tbody = document.getElementById('sellersTableBody');
            tbody.innerHTML = '<tr><td colspan="5" class="loading-row">Loading pending sellers...</td></tr>';

            try {
                const { data: sellers, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('role', 'seller')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (!sellers || sellers.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-secondary);">No seller accounts found</td></tr>';
                    return;
                }

                tbody.innerHTML = sellers.map(seller => {
                    const status = seller.status || 'pending';
                    const statusClass = status === 'approved' ? 'badge-success' :
                                       status === 'rejected' ? 'badge-danger' : 'badge-warning';
                    const createdDate = new Date(seller.created_at).toLocaleDateString();

                    let actionButtons = '';
                    if (status === 'pending') {
                        actionButtons = `
                            <button class="btn btn-success btn-sm" onclick="approveSeller('${seller.id}')">Approve</button>
                            <button class="btn btn-danger btn-sm" onclick="rejectSeller('${seller.id}')">Reject</button>
                        `;
                    } else if (status === 'rejected') {
                        actionButtons = `
                            <button class="btn btn-success btn-sm" onclick="approveSeller('${seller.id}')">Approve</button>
                        `;
                    } else {
                        actionButtons = `
                            <button class="btn btn-danger btn-sm" onclick="rejectSeller('${seller.id}')">Revoke</button>
                        `;
                    }

                    return `
                        <tr>
                            <td>${seller.email}</td>
                            <td>${seller.full_name || 'N/A'}</td>
                            <td><span class="badge ${statusClass}">${status}</span></td>
                            <td>${createdDate}</td>
                            <td>
                                <div class="action-buttons">
                                    ${actionButtons}
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading sellers:', error);
                tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: red;">Error loading sellers: ${error.message}</td></tr>`;
            }
        }

        // Approve seller account
        async function approveSeller(userId) {
            if (!confirm('Approve this seller account?')) return;

            try {
                const { error } = await supabase
                    .from('users')
                    .update({ status: 'approved' })
                    .eq('id', userId);

                if (error) throw error;

                alert('Seller account approved successfully!');
                loadSellers();

            } catch (error) {
                console.error('Error approving seller:', error);
                alert('Error approving seller: ' + error.message);
            }
        }

        // Reject seller account
        async function rejectSeller(userId) {
            if (!confirm('Reject this seller account? They will not be able to sell products.')) return;

            try {
                const { error } = await supabase
                    .from('users')
                    .update({ status: 'rejected' })
                    .eq('id', userId);

                if (error) throw error;

                alert('Seller account rejected.');
                loadSellers();

            } catch (error) {
                console.error('Error rejecting seller:', error);
                alert('Error rejecting seller: ' + error.message);
            }
        }

        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user? This will also delete all their products, orders, and related data.')) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('users')
                    .delete()
                    .eq('id', userId);

                if (error) throw error;

                alert('User deleted successfully!');
                loadUsers();
                loadDashboard(); // Refresh dashboard stats

            } catch (error) {
                console.error('Error deleting user:', error);
                alert('Error deleting user: ' + error.message);
            }
        }

        // ============================================
        // ORDERS SECTION
        // ============================================

        async function loadOrders() {
            const tbody = document.getElementById('ordersTableBody');
            tbody.innerHTML = '<tr><td colspan="6" class="loading-row">Loading orders...</td></tr>';

            try {
                const { data: orders, error } = await supabase
                    .from('orders')
                    .select(`
                        id,
                        total,
                        status,
                        created_at,
                        buyer_id,
                        users!orders_buyer_id_fkey (
                            email,
                            full_name
                        )
                    `)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (!orders || orders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-secondary);">No orders found</td></tr>';
                    return;
                }

                tbody.innerHTML = orders.map(order => {
                    const statusClass = order.status === 'delivered' ? 'badge-success' :
                                       order.status === 'cancelled' ? 'badge-danger' :
                                       order.status === 'shipped' ? 'badge-info' : 'badge-warning';
                    const orderDate = new Date(order.created_at).toLocaleDateString();

                    return `
                        <tr>
                            <td>${order.id.substring(0, 8)}...</td>
                            <td>${order.users?.email || 'Unknown'}</td>
                            <td>$${parseFloat(order.total).toFixed(2)}</td>
                            <td><span class="badge ${statusClass}">${order.status}</span></td>
                            <td>${orderDate}</td>
                            <td>
                                <select class="form-control" onchange="updateOrderStatus('${order.id}', this.value)" style="padding: 6px; font-size: 13px;">
                                    <option value="">Update Status...</option>
                                    <option value="pending" ${order.status === 'pending' ? 'disabled' : ''}>Pending</option>
                                    <option value="processing" ${order.status === 'processing' ? 'disabled' : ''}>Processing</option>
                                    <option value="shipped" ${order.status === 'shipped' ? 'disabled' : ''}>Shipped</option>
                                    <option value="delivered" ${order.status === 'delivered' ? 'disabled' : ''}>Delivered</option>
                                    <option value="cancelled" ${order.status === 'cancelled' ? 'disabled' : ''}>Cancelled</option>
                                </select>
                            </td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading orders:', error);
                tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: red;">Error loading orders: ${error.message}</td></tr>`;
            }
        }

        async function updateOrderStatus(orderId, newStatus) {
            if (!newStatus) return; // User didn't select anything

            try {
                const { error } = await supabase
                    .from('orders')
                    .update({ status: newStatus })
                    .eq('id', orderId);

                if (error) throw error;

                alert(`Order status updated to ${newStatus}!`);
                loadOrders();

            } catch (error) {
                console.error('Error updating order status:', error);
                alert('Error updating order status: ' + error.message);
            }
        }

        // ============================================
        // SETTINGS SECTION
        // ============================================

        async function loadSettings() {
            try {
                const { data: settings, error } = await supabase
                    .from('platform_settings')
                    .select('*');

                if (error) throw error;

                // Create a map of settings for easy access
                const settingsMap = {};
                settings.forEach(setting => {
                    // Parse JSONB value
                    let value = setting.setting_value;
                    if (typeof value === 'string') {
                        try {
                            value = JSON.parse(value);
                        } catch (e) {
                            // Value is already parsed or simple string
                        }
                    }
                    settingsMap[setting.setting_key] = value;
                });

                // Populate form fields
                document.getElementById('platformName').value = settingsMap.platform_name || 'London Star Marketplace';
                document.getElementById('platformEmail').value = settingsMap.platform_email || 'admin@londonstar.com';
                document.getElementById('commissionRate').value = settingsMap.commission_rate || 10;
                document.getElementById('currency').value = settingsMap.currency || 'USD';

            } catch (error) {
                console.error('Error loading settings:', error);
                alert('Error loading settings: ' + error.message);
            }
        }

        async function saveSettings(e) {
            e.preventDefault();

            const btn = document.getElementById('saveSettingsBtn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Saving...';

            try {
                const platformName = document.getElementById('platformName').value;
                const platformEmail = document.getElementById('platformEmail').value;
                const commissionRate = parseFloat(document.getElementById('commissionRate').value);
                const currency = document.getElementById('currency').value;

                // Update each setting
                const updates = [
                    { key: 'platform_name', value: platformName },
                    { key: 'platform_email', value: platformEmail },
                    { key: 'commission_rate', value: commissionRate },
                    { key: 'currency', value: currency }
                ];

                for (const update of updates) {
                    const { error } = await supabase
                        .from('platform_settings')
                        .upsert({
                            setting_key: update.key,
                            setting_value: JSON.stringify(update.value)
                        }, {
                            onConflict: 'setting_key'
                        });

                    if (error) throw error;
                }

                alert('Settings saved successfully!');

            } catch (error) {
                console.error('Error saving settings:', error);
                alert('Error saving settings: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // ============================================
        // LOGOUT HANDLER
        // ============================================

        async function handleLogout() {
            if (!confirm('Are you sure you want to sign out?')) {
                return;
            }

            try {
                // Clear admin flags
                localStorage.removeItem('isAdmin');
                localStorage.removeItem('userRole');
                localStorage.removeItem('userId');
                localStorage.removeItem('userEmail');

                // Clear session
                if (window.sessionManager) {
                    sessionManager.clearSession();
                }

                // Redirect to login
                window.location.replace('index.html');

            } catch (error) {
                console.error('Error during logout:', error);
                window.location.replace('index.html');
            }
        }

        // ============================================
        // INITIALIZE
        // ============================================

        // Settings form handler
        document.getElementById('settingsForm').addEventListener('submit', saveSettings);

        // Load dashboard on page load
        window.addEventListener('load', () => {
            loadDashboard();
        });
    </script>

    <!-- Global Footer -->
<footer class="global-footer">
    <div class="footer-container">
        <div class="footer-main">
            <div class="footer-column">
                <h3>Shop</h3>
                <ul>
                    <li><a href="marketplace.html">All Products</a></li>
                    <li><a href="marketplace.html?category=electronics">Electronics</a></li>
                    <li><a href="marketplace.html?category=fashion">Fashion</a></li>
                    <li><a href="marketplace.html?category=home">Home & Garden</a></li>
                    <li><a href="marketplace.html?category=sports">Sports & Outdoors</a></li>
                    <li><a href="marketplace.html?category=books">Books</a></li>
                    <li><a href="marketplace.html?category=toys">Toys & Games</a></li>
                    <li><a href="marketplace.html?category=beauty">Beauty & Personal Care</a></li>
                </ul>
            </div>

            <div class="footer-column">
                <h3>Sell</h3>
                <ul>
                    <li><a href="seller.html">Seller Dashboard</a></li>
                    <li><a href="index.html">Start Selling</a></li>
                    <li><a href="seller-profile.html">Seller Profile</a></li>
                    <li><a href="#">Seller Tools</a></li>
                    <li><a href="#">Seller University</a></li>
                    <li><a href="#">Advertising</a></li>
                    <li><a href="#">Pricing</a></li>
                    <li><a href="#">Resources</a></li>
                </ul>
            </div>

            <div class="footer-column">
                <h3>Customer Service</h3>
                <ul>
                    <li><a href="#">Help Center</a></li>
                    <li><a href="#">Track Your Order</a></li>
                    <li><a href="#">Returns & Refunds</a></li>
                    <li><a href="#">Shipping Info</a></li>
                    <li><a href="#">Payment Methods</a></li>
                    <li><a href="#">Contact Us</a></li>
                    <li><a href="#">FAQs</a></li>
                    <li><a href="#">Report an Issue</a></li>
                </ul>
            </div>

            <div class="footer-column">
                <h3>About Us</h3>
                <ul>
                    <li><a href="#">About London Marketplace</a></li>
                    <li><a href="#">Careers</a></li>
                    <li><a href="#">Press Center</a></li>
                    <li><a href="#">Investor Relations</a></li>
                    <li><a href="#">Sustainability</a></li>
                    <li><a href="#">Community Impact</a></li>
                    <li><a href="#">Blog</a></li>
                    <li><a href="#">Success Stories</a></li>
                </ul>
            </div>

            <div class="footer-column">
                <h3>Account</h3>
                <ul>
                    <li><a href="index.html">Sign In</a></li>
                    <li><a href="index.html">Create Account</a></li>
                    <li><a href="#">My Orders</a></li>
                    <li><a href="#">Wishlist</a></li>
                    <li><a href="#">Account Settings</a></li>
                    <li><a href="#">Gift Cards</a></li>
                    <li><a href="#">Subscriptions</a></li>
                    <li><a href="#">Notifications</a></li>
                </ul>
            </div>

            <div class="footer-column">
                <h3>Resources</h3>
                <ul>
                    <li><a href="#">Buyer Protection</a></li>
                    <li><a href="#">Trust & Safety</a></li>
                    <li><a href="#">Privacy Policy</a></li>
                    <li><a href="#">Terms of Service</a></li>
                    <li><a href="#">Cookie Policy</a></li>
                    <li><a href="#">Accessibility</a></li>
                    <li><a href="#">Sitemap</a></li>
                    <li><a href="#">Mobile App</a></li>
                </ul>
            </div>
        </div>

        <div class="footer-bottom">
            <div class="footer-logo">
                <img src="images/logo-new.svg" alt="London Marketplace">
            </div>

            <div class="footer-links">
                <a href="#">Privacy</a>
                <a href="#">Terms</a>
                <a href="#">Cookie Policy</a>
                <a href="#">Accessibility</a>
                <a href="#">Do Not Sell My Personal Information</a>
                <a href="#">Interest-Based Ads</a>
            </div>

            <div class="footer-copyright">
                &copy; 2025 London Marketplace. All rights reserved. | A premium e-commerce experience
            </div>
        </div>
    </div>
</footer>

</body>
</html>
