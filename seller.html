<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <title>Seller Dashboard - London Marketplace</title>
    <link rel="stylesheet" href="css/main.css">
    <!-- Premium Design System -->
    <link rel="stylesheet" href="css/premium-design.css">
    <link rel="stylesheet" href="css/animations.css">
    <link rel="stylesheet" href="css/skeleton.css">
    <link rel="stylesheet" href="css/footer-minimal.css">
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen hidden" id="loadingScreen">
        <img src="images/logo-new.svg" alt="London Marketplace" style="width: 200px; height: 200px; animation: pulse 1.5s ease-in-out infinite;">
        <div class="loading-spinner"></div>
        <div class="loading-text">Processing...</div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-main">
            <div class="logo-container" onclick="window.location.href='index.html'">
                <img src="images/logo-icon-new.svg" alt="London Marketplace">
            </div>
            <button class="mobile-menu-toggle" id="mobileMenuToggle" onclick="toggleMobileMenu()">
                <div class="hamburger-icon">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </button>
            <div class="search-bar">
                <input type="text" placeholder="Search products...">
                <button>
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="m21 21-4.35-4.35"/>
                    </svg>
                </button>
            </div>
            <nav class="header-nav" id="headerNav">
                <span class="nav-link" style="font-weight: 600;">Seller Dashboard</span>
                <a href="auth.html" class="nav-icon-btn" onclick="handleLogout()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" stroke="currentColor" stroke-width="2"/>
                        <polyline points="16 17 21 12 16 7" stroke="currentColor" stroke-width="2"/>
                        <line x1="21" y1="12" x2="9" y2="12" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    <span style="font-size: 12px; font-weight: 500;">Sign Out</span>
                </a>
            </nav>
        </div>
        <!-- Mobile Menu -->
        <div class="mobile-menu" id="mobileMenu">
            <div id="mobileMenuContent">
                <!-- Populated by JavaScript -->
            </div>
        </div>
    </header>

    <div class="container">
        <h1 style="margin-bottom: 30px;">Seller Dashboard</h1>

        <!-- Pending Status Alert -->
        <div id="statusAlert" style="display: none; padding: 20px; background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; margin-bottom: 30px;">
            <div style="display: flex; align-items: center; gap: 15px;">
                <svg width="40" height="40" fill="none" stroke="#856404" stroke-width="2" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="8" x2="12" y2="12"/>
                    <line x1="12" y1="16" x2="12.01" y2="16"/>
                </svg>
                <div>
                    <h3 style="margin: 0 0 8px 0; color: #856404; font-size: 18px;">Account Pending Approval</h3>
                    <p style="margin: 0; color: #856404; font-size: 14px;">Your seller account is awaiting admin approval. You cannot add or manage products until your account is approved.</p>
                </div>
            </div>
        </div>

        <!-- Rejected Status Alert -->
        <div id="rejectedAlert" style="display: none; padding: 20px; background: #f8d7da; border: 2px solid #dc3545; border-radius: 8px; margin-bottom: 30px;">
            <div style="display: flex; align-items: center; gap: 15px;">
                <svg width="40" height="40" fill="none" stroke="#721c24" stroke-width="2" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="15" y1="9" x2="9" y2="15"/>
                    <line x1="9" y1="9" x2="15" y2="15"/>
                </svg>
                <div>
                    <h3 style="margin: 0 0 8px 0; color: #721c24; font-size: 18px;">Account Not Approved</h3>
                    <p style="margin: 0; color: #721c24; font-size: 14px;">Your seller account has not been approved. Please contact support for more information.</p>
                </div>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalProducts">0</div>
                <div class="stat-label">Total Products</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalSales">0</div>
                <div class="stat-label">Total Sales</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">$<span id="totalRevenue">0.00</span></div>
                <div class="stat-label">Total Revenue</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="activeListings">0</div>
                <div class="stat-label">Active Listings</div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex gap-20 mb-20">
            <button class="btn btn-primary" onclick="openProductModal()">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 8px;">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                Add New Product
            </button>
            <button class="btn btn-secondary" onclick="openPaymentSetup()">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 8px;">
                    <rect x="1" y="4" width="22" height="16" rx="2"/>
                    <line x1="1" y1="10" x2="23" y2="10"/>
                </svg>
                Payment Setup
            </button>
        </div>

        <!-- Products Grid -->
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">Your Products</h2>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" onclick="openBulkUploadModal()">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 4px;">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="17 8 12 3 7 8"/>
                            <line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                        Bulk Upload
                    </button>
                    <button class="btn btn-primary" onclick="openProductModal()">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 4px;">
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        Add Product
                    </button>
                </div>
            </div>
            <div id="alertContainer"></div>
            <div class="grid grid-4" id="productsGrid">
                <!-- Products will be loaded here -->
            </div>
            <div id="emptyState" style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                <svg width="80" height="80" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" style="margin: 0 auto 20px;">
                    <path d="M20 7H4c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V9c0-1.1-.9-2-2-2z"/>
                    <path d="M16 21V5c0-1.1-.9-2-2-2h-4c-1.1 0-2 .9-2 2v16"/>
                </svg>
                <h3>No products yet</h3>
                <p>Start selling by adding your first product</p>
                <button class="btn btn-primary mt-20" onclick="openProductModal()">Add Product</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Product Modal -->
    <div class="modal" id="productModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add New Product</h2>
                <button class="close-modal" onclick="closeProductModal()">&times;</button>
            </div>
            <form id="productForm" onsubmit="handleProductSubmit(event)">
                <div class="form-group">
                    <label>Product Name *</label>
                    <input type="text" id="productName" required placeholder="Enter product name">
                </div>
                <div class="form-group">
                    <label>Price (USD) *</label>
                    <input type="number" id="productPrice" step="0.01" min="0" required placeholder="0.00">
                </div>
                <div class="form-group">
                    <label>Category *</label>
                    <select id="productCategory" required>
                        <option value="">Select category</option>
                        <option value="electronics">Electronics</option>
                        <option value="fashion">Fashion</option>
                        <option value="home">Home & Garden</option>
                        <option value="sports">Sports & Outdoors</option>
                        <option value="books">Books</option>
                        <option value="toys">Toys & Games</option>
                        <option value="beauty">Beauty & Personal Care</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Description *</label>
                    <textarea id="productDescription" rows="4" required placeholder="Describe your product"></textarea>
                </div>
                <div class="form-group">
                    <label>Stock Quantity *</label>
                    <input type="number" id="productStock" min="0" required placeholder="0">
                </div>

                <!-- Advanced Options Section -->
                <div id="advancedOptionsSection" style="display: none; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                    <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--primary-color);">Advanced Options</h3>

                    <div class="form-group" style="margin-bottom: 12px;">
                        <label>Product Status</label>
                        <select id="productStatus">
                            <option value="active">Active (Visible in marketplace)</option>
                            <option value="inactive">Inactive (Hidden from marketplace)</option>
                            <option value="draft">Draft (Not yet published)</option>
                        </select>
                    </div>

                    <div class="form-group" style="margin-bottom: 12px;">
                        <label>SKU / Product Code (Optional)</label>
                        <input type="text" id="productSKU" placeholder="e.g., PROD-001">
                        <small style="color: #6b7280; display: block; margin-top: 4px;">Unique identifier for inventory tracking</small>
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="productFeatured" style="width: auto; cursor: pointer;">
                            <span>Mark as Featured Product</span>
                        </label>
                        <small style="color: #6b7280; display: block; margin-top: 4px; margin-left: 28px;">Featured products appear at the top of search results</small>
                    </div>
                </div>

                <div class="form-group">
                    <label style="display: flex; justify-content: space-between; align-items: center;">
                        <span>Product Images *</span>
                        <span id="imageCount" style="font-size: 13px; color: var(--text-secondary); font-weight: normal;">0 images uploaded</span>
                    </label>
                    <div class="file-upload" id="fileUpload" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" onclick="document.getElementById('fileInput').click()">
                        <svg width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" style="margin: 0 auto 10px;">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="17 8 12 3 7 8"/>
                            <line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                        <p>Click to upload or drag and drop</p>
                        <p style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">PNG, JPG up to 5MB â€¢ Multiple images supported</p>
                    </div>
                    <input type="file" id="fileInput" accept="image/*" multiple style="display: none;" onchange="handleFileSelect(event)">
                    <div id="imagePreview" class="grid grid-4 mt-10"></div>
                </div>

                <!-- Product Info (shown only in edit mode) -->
                <div id="productInfoSection" style="display: none; background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 13px;">
                        <div>
                            <span style="color: #6b7280;">Created:</span>
                            <span id="productCreatedDate" style="font-weight: 600; margin-left: 4px;">-</span>
                        </div>
                        <div>
                            <span style="color: #6b7280;">Last Updated:</span>
                            <span id="productUpdatedDate" style="font-weight: 600; margin-left: 4px;">-</span>
                        </div>
                    </div>
                </div>

                <div class="flex gap-10">
                    <button type="button" class="btn btn-secondary" onclick="closeProductModal()">Cancel</button>
                    <button type="button" id="duplicateBtn" class="btn" onclick="duplicateProduct()" style="background: #3b82f6; color: white; display: none;">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 6px;">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                        </svg>
                        Duplicate
                    </button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Save Product</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Payment Setup Modal -->
    <div class="modal" id="paymentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Payment Setup</h2>
                <button class="close-modal" onclick="closePaymentModal()">&times;</button>
            </div>
            <form id="paymentForm" onsubmit="handlePaymentSetup(event)">
                <div class="alert alert-info mb-20">
                    Set up your payment information to receive payments from customers.
                </div>
                <div class="form-group">
                    <label>Payment Method</label>
                    <select id="paymentMethod" required>
                        <option value="">Select payment method</option>
                        <option value="stripe">Stripe</option>
                        <option value="paypal">PayPal</option>
                        <option value="bank">Bank Transfer</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Account Email</label>
                    <input type="email" id="paymentEmail" required placeholder="payment@example.com">
                </div>
                <div class="form-group">
                    <label>Account Number / ID</label>
                    <input type="text" id="paymentAccountId" required placeholder="Enter account ID">
                </div>
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="paymentName" required placeholder="Account holder name">
                </div>
                <div class="flex gap-10">
                    <button type="button" class="btn btn-secondary" onclick="closePaymentModal()">Cancel</button>
                    <button type="submit" class="btn btn-success" style="flex: 1;">Save Payment Info</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Bulk Upload Modal -->
    <div class="modal" id="bulkUploadModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>Bulk Upload Products</h2>
                <button class="close-modal" onclick="closeBulkUploadModal()">&times;</button>
            </div>
            <div style="background: #e0f2fe; border: 1px solid #7dd3fc; border-radius: 8px; padding: 12px; margin-bottom: 20px;">
                <p style="margin: 0; font-size: 14px; color: #075985;">
                    <strong>ðŸ’¡ Tip:</strong> Add multiple products at once. Each product can have multiple images.
                </p>
            </div>
            <form id="bulkUploadForm" onsubmit="handleBulkUpload(event)">
                <div id="bulkProductsContainer">
                    <!-- Product forms will be added here -->
                </div>
                <button type="button" class="btn btn-secondary" onclick="addProductForm()" style="width: 100%; margin-bottom: 20px;">
                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 4px;">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Add Another Product
                </button>
                <div class="flex gap-10">
                    <button type="button" class="btn btn-secondary" onclick="closeBulkUploadModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;" id="bulkUploadBtn">Upload All Products</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/supabase-init.js"></script>
    <script src="js/cache-manager.js"></script>
    <script src="js/session-manager.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/scroll-effects.js"></script>
    <script src="js/product-manager.js"></script>

    <!-- Security & Validation -->
    <script src="js/security.js"></script>
    <script src="js/dom-builder.js"></script>

    <script>
        let products = [];
        let selectedImages = [];
        let editingProductId = null;
        let currentUserId = null;

        // Mobile Menu Functions
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            const toggle = document.getElementById('mobileMenuToggle');

            mobileMenu.classList.toggle('active');
            toggle.classList.toggle('active');

            // Prevent background scroll when menu is open
            if (mobileMenu.classList.contains('active')) {
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = '';
            }
        }

        // Close mobile menu when clicking outside
        document.addEventListener('click', function(event) {
            const mobileMenu = document.getElementById('mobileMenu');
            const toggle = document.getElementById('mobileMenuToggle');

            if (mobileMenu && toggle && mobileMenu.classList.contains('active')) {
                if (!mobileMenu.contains(event.target) && !toggle.contains(event.target)) {
                    mobileMenu.classList.remove('active');
                    toggle.classList.remove('active');
                    document.body.style.overflow = '';
                }
            }
        });

        // Populate mobile menu (SAFE - cloning DOM nodes)
        function populateMobileMenu() {
            const headerNav = document.getElementById('headerNav');
            const mobileMenuContent = document.getElementById('mobileMenuContent');
            if (headerNav && mobileMenuContent) {
                mobileMenuContent.textContent = '';
                // Clone all header nav children to mobile menu
                Array.from(headerNav.childNodes).forEach(node => {
                    mobileMenuContent.appendChild(node.cloneNode(true));
                });
            }
        }

        // Check authentication and account status
        async function checkAuth() {
            if (!sessionManager.requireAuth()) return false;
            if (sessionManager.checkLoggedOut()) return false;
            currentUserId = sessionManager.getUserId();
            if (!currentUserId) {
                window.location.href = 'auth.html';
                return false;
            }

            // Check seller account status
            await checkSellerStatus();

            return true;
        }

        // Check if seller account is approved
        async function checkSellerStatus() {
            try {
                const { data: user, error } = await supabase
                    .from('users')
                    .select('status')
                    .eq('id', currentUserId)
                    .single();

                if (error) {
                    console.error('Error checking seller status:', error);
                    return;
                }

                const status = user?.status || 'pending';

                if (status === 'pending') {
                    // Show pending alert
                    document.getElementById('statusAlert').style.display = 'block';
                    // Disable add product button
                    const addBtn = document.querySelector('[onclick="openProductModal()"]');
                    if (addBtn) {
                        addBtn.disabled = true;
                        addBtn.style.opacity = '0.5';
                        addBtn.style.cursor = 'not-allowed';
                    }
                } else if (status === 'rejected') {
                    // Show rejected alert
                    document.getElementById('rejectedAlert').style.display = 'block';
                    // Disable add product button
                    const addBtn = document.querySelector('[onclick="openProductModal()"]');
                    if (addBtn) {
                        addBtn.disabled = true;
                        addBtn.style.opacity = '0.5';
                        addBtn.style.cursor = 'not-allowed';
                    }
                }

            } catch (error) {
                console.error('Error checking seller status:', error);
            }
        }

        // Load products for current user only with Cache
        async function loadProducts() {
            if (!currentUserId) {
                const authSuccess = await checkAuth();
                if (!authSuccess) return;
            }

            try {
                // Try to get from cache first
                const cachedProducts = await cacheManager.fetchWithCache(
                    'PRODUCTS',
                    `seller_${currentUserId}`,
                    async () => {
                        const result = await productManager.getProductsBySeller(currentUserId);
                        if (result.success) {
                            return result.data || [];
                        } else {
                            const stored = localStorage.getItem('sellerProducts');
                            const allProducts = stored ? JSON.parse(stored) : [];
                            return allProducts.filter(p => p.seller_id === currentUserId);
                        }
                    },
                    cacheManager.TTL.PRODUCTS
                );

                products = cachedProducts;

                // Preload product images
                const imageUrls = products.flatMap(p =>
                    Array.isArray(p.images) ? p.images : []
                ).filter(url => url);

                if (imageUrls.length > 0) {
                    cacheManager.preloadImages(imageUrls, 'SELLER_PRODUCT_IMAGE')
                        .catch(err => console.warn('Image preload error:', err));
                }

                renderProducts();
                updateStats();
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }

        // Save products to localStorage
        function saveProducts() {
            localStorage.setItem('sellerProducts', JSON.stringify(products));
            renderProducts();
            updateStats();
        }

        // Render products
        function renderProducts() {
            const grid = document.getElementById('productsGrid');
            const emptyState = document.getElementById('emptyState');

            if (products.length === 0) {
                grid.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            grid.style.display = 'grid';
            emptyState.style.display = 'none';

            // Clear grid safely
            grid.textContent = '';

            // Render products using safe DOM manipulation
            products.forEach(product => {
                const status = product.status || 'active';
                const statusColors = {
                    active: { bg: '#10b981', text: 'Active' },
                    inactive: { bg: '#6b7280', text: 'Inactive' },
                    draft: { bg: '#f59e0b', text: 'Draft' }
                };
                const statusConfig = statusColors[status] || statusColors.active;

                const card = DOMBuilder.div({
                    className: 'product-card scroll-fade',
                    style: { position: 'relative' }
                });

                // Featured badge
                if (product.featured) {
                    const featuredBadge = DOMBuilder.div({
                        style: {
                            position: 'absolute',
                            top: '8px',
                            left: '8px',
                            background: 'var(--accent-color)',
                            color: '#111',
                            padding: '4px 10px',
                            borderRadius: '4px',
                            fontSize: '11px',
                            fontWeight: '700',
                            zIndex: '1',
                            boxShadow: '0 2px 4px rgba(0,0,0,0.2)'
                        },
                        text: 'â­ FEATURED'
                    });
                    card.appendChild(featuredBadge);
                }

                // Status badge
                const statusBadge = DOMBuilder.div({
                    style: {
                        position: 'absolute',
                        top: '8px',
                        right: '8px',
                        background: statusConfig.bg,
                        color: 'white',
                        padding: '4px 10px',
                        borderRadius: '4px',
                        fontSize: '11px',
                        fontWeight: '600',
                        zIndex: '1'
                    },
                    text: statusConfig.text
                });
                card.appendChild(statusBadge);

                // Product image
                const img = DOMBuilder.img({
                    attrs: {
                        src: product.images[0],
                        alt: product.name  // SAFE - alt attribute
                    },
                    className: 'product-image'
                });
                card.appendChild(img);

                // Product title (SAFE - textContent prevents XSS)
                const title = DOMBuilder.div({
                    className: 'product-title',
                    text: product.name
                });
                card.appendChild(title);

                // SKU (SAFE - textContent prevents XSS)
                if (product.sku) {
                    const skuDiv = DOMBuilder.div({
                        style: { fontSize: '12px', color: '#6b7280', marginTop: '4px' },
                        text: `SKU: ${product.sku}`
                    });
                    card.appendChild(skuDiv);
                }

                // Price
                const price = DOMBuilder.div({
                    className: 'product-price',
                    text: `J$${parseFloat(product.price).toFixed(2)}`
                });
                card.appendChild(price);

                // Description (SAFE - textContent prevents XSS)
                const description = DOMBuilder.div({
                    className: 'product-description',
                    text: product.description
                });
                card.appendChild(description);

                // Stock and category (SAFE - textContent prevents XSS)
                const stockCat = DOMBuilder.div({
                    style: { marginTop: '12px', fontSize: '13px', color: 'var(--text-secondary)' },
                    text: `Stock: ${product.stock} | Category: ${product.category}`
                });
                card.appendChild(stockCat);

                // Image count
                if (product.images && product.images.length > 1) {
                    const imageCount = DOMBuilder.div({
                        style: { marginTop: '8px', fontSize: '12px', color: 'var(--text-secondary)' },
                        text: `ðŸ“· ${product.images.length} images`
                    });
                    card.appendChild(imageCount);
                }

                // Action buttons
                const buttonsDiv = DOMBuilder.div({
                    className: 'flex gap-10 mt-10'
                });

                // Edit button
                const editBtn = document.createElement('button');
                editBtn.className = 'btn btn-secondary';
                editBtn.style.cssText = 'flex: 1; padding: 8px;';
                editBtn.onclick = () => editProduct(product.id);
                editBtn.innerHTML = '<svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 4px;"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg> Edit';
                buttonsDiv.appendChild(editBtn);

                // Delete button
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-danger';
                deleteBtn.style.cssText = 'flex: 1; padding: 8px;';
                deleteBtn.onclick = () => deleteProduct(product.id);
                deleteBtn.innerHTML = '<svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 4px;"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg> Delete';
                buttonsDiv.appendChild(deleteBtn);

                card.appendChild(buttonsDiv);
                grid.appendChild(card);
            });

            // Trigger scroll effects for product cards
            if (window.scrollEffects) {
                window.scrollEffects.addScrollFade('.product-card');
            }
        }

        // Update stats
        function updateStats() {
            document.getElementById('totalProducts').textContent = products.length;
            document.getElementById('activeListings').textContent = products.filter(p => p.stock > 0).length;
            // These would come from actual sales data
            document.getElementById('totalSales').textContent = '0';
            document.getElementById('totalRevenue').textContent = '0.00';
        }

        // Product modal functions
        async function openProductModal() {
            // Check if seller account is approved
            try {
                const { data: user, error } = await supabase
                    .from('users')
                    .select('status')
                    .eq('id', currentUserId)
                    .single();

                const status = user?.status || 'pending';

                if (status !== 'approved') {
                    alert('Your seller account must be approved by an admin before you can add products.');
                    return;
                }
            } catch (error) {
                console.error('Error checking status:', error);
            }

            editingProductId = null;
            document.getElementById('modalTitle').textContent = 'Add New Product';
            document.getElementById('productForm').reset();
            selectedImages = [];
            document.getElementById('imagePreview').innerHTML = '';

            // Hide advanced sections for new products (can be shown with toggle if needed)
            document.getElementById('advancedOptionsSection').style.display = 'none';
            document.getElementById('duplicateBtn').style.display = 'none';
            document.getElementById('productInfoSection').style.display = 'none';

            // Set default status for new products
            document.getElementById('productStatus').value = 'active';

            document.getElementById('productModal').classList.add('active');
        }

        function closeProductModal() {
            document.getElementById('productModal').classList.remove('active');
            document.getElementById('productForm').reset();
            selectedImages = [];
            document.getElementById('imagePreview').innerHTML = '';
            editingProductId = null;

            // Reset advanced sections
            document.getElementById('advancedOptionsSection').style.display = 'none';
            document.getElementById('duplicateBtn').style.display = 'none';
            document.getElementById('productInfoSection').style.display = 'none';
        }

        function editProduct(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;

            editingProductId = id;

            // Update modal title and UI
            document.getElementById('modalTitle').textContent = 'Edit Product';

            // Basic fields
            document.getElementById('productName').value = product.name;
            document.getElementById('productPrice').value = product.price;
            document.getElementById('productCategory').value = product.category;
            document.getElementById('productDescription').value = product.description;
            document.getElementById('productStock').value = product.stock;

            // Advanced fields
            document.getElementById('productStatus').value = product.status || 'active';
            document.getElementById('productSKU').value = product.sku || '';
            document.getElementById('productFeatured').checked = product.featured || false;

            // Show advanced options and duplicate button in edit mode
            document.getElementById('advancedOptionsSection').style.display = 'block';
            document.getElementById('duplicateBtn').style.display = 'inline-flex';
            document.getElementById('productInfoSection').style.display = 'block';

            // Format and show dates
            if (product.created_at) {
                const created = new Date(product.created_at);
                document.getElementById('productCreatedDate').textContent = created.toLocaleDateString('en-US', {
                    year: 'numeric', month: 'short', day: 'numeric'
                });
            }
            if (product.updated_at) {
                const updated = new Date(product.updated_at);
                document.getElementById('productUpdatedDate').textContent = updated.toLocaleDateString('en-US', {
                    year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                });
            } else if (product.created_at) {
                document.getElementById('productUpdatedDate').textContent = 'Not modified';
            }

            // Load existing images
            selectedImages = Array.isArray(product.images) ? [...product.images] : [];
            renderImagePreviews();

            document.getElementById('productModal').classList.add('active');
        }

        // Duplicate product
        function duplicateProduct() {
            if (!editingProductId) return;

            // Clear the editing ID so it saves as new product
            editingProductId = null;

            // Update UI
            document.getElementById('modalTitle').textContent = 'Add New Product (Duplicated)';
            document.getElementById('duplicateBtn').style.display = 'none';
            document.getElementById('productInfoSection').style.display = 'none';

            // Add " (Copy)" to the product name
            const currentName = document.getElementById('productName').value;
            document.getElementById('productName').value = currentName + ' (Copy)';

            // Clear SKU to avoid duplicate SKU conflicts
            document.getElementById('productSKU').value = '';

            // Keep all other fields as they are (images, description, price, etc.)
            // Set status to draft for review
            document.getElementById('productStatus').value = 'draft';

            showAlert('Product duplicated! Review details and click "Save Product" to create a copy.', 'info');
        }

        async function deleteProduct(id) {
            if (confirm('Are you sure you want to delete this product?')) {
                showLoading();
                try {
                    const result = await productManager.deleteProduct(id, currentUserId);
                    if (result.success) {
                        products = products.filter(p => p.id !== id);
                        saveProducts();
                        // Invalidate cache
                        cacheManager.invalidateProducts();
                        await loadProducts();
                        showAlert('Product deleted successfully', 'success');
                    } else {
                        showAlert(result.error || 'Failed to delete product', 'error');
                    }
                } catch (error) {
                    console.error('Error deleting product:', error);
                    showAlert('Error deleting product', 'error');
                } finally {
                    hideLoading();
                }
            }
        }

        // File upload handlers
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('fileUpload').classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('fileUpload').classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('fileUpload').classList.remove('drag-over');
            const files = e.dataTransfer.files;
            processFiles(files);
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            processFiles(files);
        }

        function processFiles(files) {
            Array.from(files).forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        selectedImages.push(e.target.result);
                        renderImagePreviews();
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        function renderImagePreviews() {
            const preview = document.getElementById('imagePreview');
            const imageCount = document.getElementById('imageCount');

            preview.innerHTML = selectedImages.map((img, idx) => `
                <div style="position: relative; border: ${idx === 0 ? '3px solid var(--accent-color)' : '2px solid #e5e7eb'}; border-radius: 8px; overflow: hidden;">
                    <img src="${img}" style="width: 100%; height: 100px; object-fit: cover; display: block;">

                    ${idx === 0 ? `
                        <div style="position: absolute; top: 5px; left: 5px; background: var(--accent-color); color: #111; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 700;">PRIMARY</div>
                    ` : ''}

                    <button type="button" onclick="removeImage(${idx})" style="position: absolute; top: 5px; right: 5px; background: rgba(239, 68, 68, 0.9); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; padding: 0;">&times;</button>

                    ${selectedImages.length > 1 ? `
                        <div style="position: absolute; bottom: 5px; right: 5px; display: flex; gap: 4px;">
                            ${idx > 0 ? `
                                <button type="button" onclick="moveImageUp(${idx})" title="Move left" style="background: rgba(0, 0, 0, 0.7); color: white; border: none; border-radius: 4px; width: 28px; height: 28px; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0;">
                                    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                        <polyline points="15 18 9 12 15 6"></polyline>
                                    </svg>
                                </button>
                            ` : ''}
                            ${idx < selectedImages.length - 1 ? `
                                <button type="button" onclick="moveImageDown(${idx})" title="Move right" style="background: rgba(0, 0, 0, 0.7); color: white; border: none; border-radius: 4px; width: 28px; height: 28px; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0;">
                                    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                        <polyline points="9 18 15 12 9 6"></polyline>
                                    </svg>
                                </button>
                            ` : ''}
                        </div>
                    ` : ''}
                </div>
            `).join('');

            // Update image count label
            const count = selectedImages.length;
            imageCount.textContent = `${count} image${count !== 1 ? 's' : ''} uploaded`;
            imageCount.style.color = count > 0 ? 'var(--success-color)' : 'var(--text-secondary)';
        }

        function removeImage(index) {
            selectedImages.splice(index, 1);
            renderImagePreviews();
        }

        function moveImageUp(index) {
            if (index > 0) {
                [selectedImages[index - 1], selectedImages[index]] = [selectedImages[index], selectedImages[index - 1]];
                renderImagePreviews();
            }
        }

        function moveImageDown(index) {
            if (index < selectedImages.length - 1) {
                [selectedImages[index], selectedImages[index + 1]] = [selectedImages[index + 1], selectedImages[index]];
                renderImagePreviews();
            }
        }

        // Handle product submit
        async function handleProductSubmit(e) {
            e.preventDefault();

            if (selectedImages.length === 0) {
                showAlert('Please upload at least one image', 'error');
                return;
            }

            const formData = {
                name: document.getElementById('productName').value,
                price: document.getElementById('productPrice').value,
                category: document.getElementById('productCategory').value,
                description: document.getElementById('productDescription').value,
                stock: parseInt(document.getElementById('productStock').value),
                images: selectedImages,
                seller_id: currentUserId,
                status: document.getElementById('productStatus').value,
                sku: document.getElementById('productSKU').value || null,
                featured: document.getElementById('productFeatured').checked
            };

            showLoading();

            try {
                let result;
                if (editingProductId) {
                    result = await productManager.updateProduct(editingProductId, formData, currentUserId);
                    if (result.success) {
                        const index = products.findIndex(p => p.id === editingProductId);
                        if (index !== -1) products[index] = result.data[0];
                        showAlert('Product updated successfully!', 'success');
                    } else {
                        showAlert(result.error || 'Failed to update product', 'error');
                    }
                } else {
                    result = await productManager.createProduct(formData);
                    if (result.success) {
                        products.push(result.data[0]);
                        showAlert('Product added successfully!', 'success');
                    } else {
                        showAlert(result.error || 'Failed to add product', 'error');
                    }
                }

                if (result.success) {
                    saveProducts();
                    // Invalidate cache so next load fetches fresh data
                    cacheManager.invalidateProducts();
                    await loadProducts(); // Reload products
                    closeProductModal();
                }
            } catch (error) {
                console.error('Error saving product:', error);
                showAlert('Error saving product', 'error');
            } finally {
                hideLoading();
            }
        }

        // Payment modal
        function openPaymentSetup() {
            document.getElementById('paymentModal').classList.add('active');
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').classList.remove('active');
        }

        function handlePaymentSetup(e) {
            e.preventDefault();
            showLoading();

            const paymentData = {
                method: document.getElementById('paymentMethod').value,
                email: document.getElementById('paymentEmail').value,
                accountId: document.getElementById('paymentAccountId').value,
                name: document.getElementById('paymentName').value
            };

            setTimeout(() => {
                localStorage.setItem('paymentSetup', JSON.stringify(paymentData));
                showAlert('Payment information saved successfully!', 'success');
                closePaymentModal();
                hideLoading();
            }, 1000);
        }

        // ============================================
        // BULK UPLOAD FUNCTIONS
        // ============================================

        let bulkProducts = [];
        let productFormCounter = 0;

        function openBulkUploadModal() {
            bulkProducts = [];
            productFormCounter = 0;
            document.getElementById('bulkProductsContainer').innerHTML = '';
            addProductForm(); // Add first product form
            document.getElementById('bulkUploadModal').classList.add('active');
        }

        function closeBulkUploadModal() {
            document.getElementById('bulkUploadModal').classList.remove('active');
            bulkProducts = [];
            productFormCounter = 0;
        }

        function addProductForm() {
            const formId = productFormCounter++;
            const container = document.getElementById('bulkProductsContainer');

            const productFormHTML = `
                <div class="bulk-product-form" id="bulkProduct${formId}" style="background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 12px; padding: 20px; margin-bottom: 20px; position: relative;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 style="margin: 0; color: var(--primary-color);">Product #${formId + 1}</h3>
                        ${bulkProducts.length > 0 ? `
                            <button type="button" class="btn btn-danger" onclick="removeProductForm(${formId})" style="padding: 6px 12px;">
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <line x1="18" y1="6" x2="6" y2="18"/>
                                    <line x1="6" y1="6" x2="18" y2="18"/>
                                </svg>
                                Remove
                            </button>
                        ` : ''}
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div class="form-group">
                            <label>Product Name *</label>
                            <input type="text" id="bulkName${formId}" required placeholder="Enter product name">
                        </div>
                        <div class="form-group">
                            <label>Price (JMD) *</label>
                            <input type="number" id="bulkPrice${formId}" step="0.01" min="0" required placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label>Category *</label>
                            <select id="bulkCategory${formId}" required>
                                <option value="">Select category</option>
                                <option value="electronics">Electronics</option>
                                <option value="fashion">Fashion</option>
                                <option value="home">Home & Garden</option>
                                <option value="sports">Sports & Outdoors</option>
                                <option value="books">Books</option>
                                <option value="toys">Toys & Games</option>
                                <option value="beauty">Beauty & Personal Care</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Stock Quantity *</label>
                            <input type="number" id="bulkStock${formId}" min="0" required placeholder="0">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Description *</label>
                        <textarea id="bulkDescription${formId}" rows="3" required placeholder="Describe your product"></textarea>
                    </div>

                    <div class="form-group">
                        <label style="display: flex; justify-content: space-between; align-items: center;">
                            <span>Product Images *</span>
                            <span id="bulkImageCount${formId}" style="font-size: 13px; color: var(--text-secondary); font-weight: normal;">0 images</span>
                        </label>
                        <div class="file-upload" onclick="document.getElementById('bulkFileInput${formId}').click()" style="cursor: pointer;">
                            <svg width="36" height="36" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" style="margin: 0 auto 8px;">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="17 8 12 3 7 8"/>
                                <line x1="12" y1="3" x2="12" y2="15"/>
                            </svg>
                            <p style="margin: 0; font-size: 14px;">Click to upload images</p>
                            <p style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">Multiple images supported</p>
                        </div>
                        <input type="file" id="bulkFileInput${formId}" accept="image/*" multiple style="display: none;" onchange="handleBulkFileSelect(event, ${formId})">
                        <div id="bulkImagePreview${formId}" class="grid grid-4 mt-10"></div>
                    </div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', productFormHTML);
            bulkProducts[formId] = { images: [] };
        }

        function removeProductForm(formId) {
            const form = document.getElementById(`bulkProduct${formId}`);
            if (form) {
                form.remove();
                delete bulkProducts[formId];

                // Renumber remaining products
                const forms = document.querySelectorAll('.bulk-product-form');
                forms.forEach((form, idx) => {
                    const heading = form.querySelector('h3');
                    if (heading) {
                        heading.textContent = `Product #${idx + 1}`;
                    }
                });
            }
        }

        function handleBulkFileSelect(event, formId) {
            const files = event.target.files;
            Array.from(files).forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        if (!bulkProducts[formId]) bulkProducts[formId] = { images: [] };
                        bulkProducts[formId].images.push(e.target.result);
                        renderBulkImagePreviews(formId);
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        function renderBulkImagePreviews(formId) {
            const preview = document.getElementById(`bulkImagePreview${formId}`);
            const imageCount = document.getElementById(`bulkImageCount${formId}`);
            const images = bulkProducts[formId]?.images || [];

            preview.innerHTML = images.map((img, idx) => `
                <div style="position: relative; border: ${idx === 0 ? '3px solid var(--accent-color)' : '2px solid #e5e7eb'}; border-radius: 8px; overflow: hidden;">
                    <img src="${img}" style="width: 100%; height: 80px; object-fit: cover; display: block;">

                    ${idx === 0 ? `
                        <div style="position: absolute; top: 3px; left: 3px; background: var(--accent-color); color: #111; padding: 2px 6px; border-radius: 3px; font-size: 9px; font-weight: 700;">PRIMARY</div>
                    ` : ''}

                    <button type="button" onclick="removeBulkImage(${formId}, ${idx})" style="position: absolute; top: 3px; right: 3px; background: rgba(239, 68, 68, 0.9); color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; padding: 0;">&times;</button>

                    ${images.length > 1 ? `
                        <div style="position: absolute; bottom: 3px; right: 3px; display: flex; gap: 3px;">
                            ${idx > 0 ? `
                                <button type="button" onclick="moveBulkImageUp(${formId}, ${idx})" title="Move left" style="background: rgba(0, 0, 0, 0.7); color: white; border: none; border-radius: 3px; width: 22px; height: 22px; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0;">
                                    <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                        <polyline points="15 18 9 12 15 6"></polyline>
                                    </svg>
                                </button>
                            ` : ''}
                            ${idx < images.length - 1 ? `
                                <button type="button" onclick="moveBulkImageDown(${formId}, ${idx})" title="Move right" style="background: rgba(0, 0, 0, 0.7); color: white; border: none; border-radius: 3px; width: 22px; height: 22px; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0;">
                                    <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                        <polyline points="9 18 15 12 9 6"></polyline>
                                    </svg>
                                </button>
                            ` : ''}
                        </div>
                    ` : ''}
                </div>
            `).join('');

            const count = images.length;
            imageCount.textContent = `${count} image${count !== 1 ? 's' : ''}`;
            imageCount.style.color = count > 0 ? 'var(--success-color)' : 'var(--text-secondary)';
        }

        function removeBulkImage(formId, imageIndex) {
            if (bulkProducts[formId] && bulkProducts[formId].images) {
                bulkProducts[formId].images.splice(imageIndex, 1);
                renderBulkImagePreviews(formId);
            }
        }

        function moveBulkImageUp(formId, index) {
            const images = bulkProducts[formId]?.images;
            if (images && index > 0) {
                [images[index - 1], images[index]] = [images[index], images[index - 1]];
                renderBulkImagePreviews(formId);
            }
        }

        function moveBulkImageDown(formId, index) {
            const images = bulkProducts[formId]?.images;
            if (images && index < images.length - 1) {
                [images[index], images[index + 1]] = [images[index + 1], images[index]];
                renderBulkImagePreviews(formId);
            }
        }

        async function handleBulkUpload(e) {
            e.preventDefault();

            const btn = document.getElementById('bulkUploadBtn');
            btn.disabled = true;
            btn.textContent = 'Uploading...';

            showLoading();

            try {
                const productsToUpload = [];

                // Collect all product data
                for (const [formId, product] of Object.entries(bulkProducts)) {
                    if (!product) continue;

                    const name = document.getElementById(`bulkName${formId}`)?.value;
                    const price = document.getElementById(`bulkPrice${formId}`)?.value;
                    const category = document.getElementById(`bulkCategory${formId}`)?.value;
                    const description = document.getElementById(`bulkDescription${formId}`)?.value;
                    const stock = document.getElementById(`bulkStock${formId}`)?.value;

                    if (!name || !price || !category || !description || !stock) continue;

                    if (!product.images || product.images.length === 0) {
                        showAlert(`Product "${name}" must have at least one image`, 'error');
                        btn.disabled = false;
                        btn.textContent = 'Upload All Products';
                        hideLoading();
                        return;
                    }

                    productsToUpload.push({
                        name,
                        price: parseFloat(price),
                        category,
                        description,
                        stock: parseInt(stock),
                        images: product.images,
                        seller_id: currentUserId
                    });
                }

                if (productsToUpload.length === 0) {
                    showAlert('Please add at least one product with all required fields', 'error');
                    btn.disabled = false;
                    btn.textContent = 'Upload All Products';
                    hideLoading();
                    return;
                }

                // Upload all products
                let successCount = 0;
                let failCount = 0;

                for (const productData of productsToUpload) {
                    try {
                        const result = await productManager.addProduct(productData, currentUserId);
                        if (result.success) {
                            successCount++;
                            products.push(result.data[0]);
                        } else {
                            failCount++;
                            console.error(`Failed to upload ${productData.name}:`, result.error);
                        }
                    } catch (error) {
                        failCount++;
                        console.error(`Error uploading ${productData.name}:`, error);
                    }
                }

                // Show results
                if (successCount > 0) {
                    showAlert(`Successfully uploaded ${successCount} product${successCount > 1 ? 's' : ''}!`, 'success');
                    // Invalidate cache to force fresh data
                    cacheManager.invalidateProducts();
                    await loadProducts();
                    closeBulkUploadModal();
                }

                if (failCount > 0) {
                    showAlert(`${failCount} product${failCount > 1 ? 's' : ''} failed to upload. Check console for details.`, 'error');
                }

            } catch (error) {
                console.error('Bulk upload error:', error);
                showAlert('Error uploading products: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Upload All Products';
                hideLoading();
            }
        }

        // Utility functions
        function showAlert(message, type = 'info') {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.innerHTML = '';
            container.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }

        function showLoading() {
            document.getElementById('loadingScreen').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingScreen').classList.add('hidden');
        }

        async function handleLogout() {
            try {
                // Clear session data
                sessionManager.clearSession();

                // Sign out from Supabase
                const { error } = await supabase.auth.signOut();
                if (error) console.error('Logout error:', error);

                // Redirect to homepage
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Error during logout:', error);
                // Still redirect even if there's an error
                window.location.href = 'index.html';
            }
        }

        // Initialize
        window.addEventListener('load', () => {
            loadProducts();
            populateMobileMenu();
        });
    </script>


<!-- Minimalistic Global Footer -->
<footer class="global-footer">
    <div class="footer-container">
        <!-- Footer Main: About + Navigation -->
        <div class="footer-main">
            <!-- About Column -->
            <div class="footer-column footer-about">
                <div class="footer-logo">
                    <img src="images/logo-new.svg" alt="London Star Marketplace">
                </div>
                <p class="footer-about-text">
                    Your premier destination for quality products from trusted sellers worldwide.
                    Shop with confidence and discover amazing deals every day.
                </p>
                <div class="footer-social">
                    <a href="#" class="social-icon" aria-label="Facebook">
                        <svg fill="currentColor" viewBox="0 0 24 24">
                            <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                        </svg>
                    </a>
                    <a href="#" class="social-icon" aria-label="Twitter">
                        <svg fill="currentColor" viewBox="0 0 24 24">
                            <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>
                        </svg>
                    </a>
                    <a href="#" class="social-icon" aria-label="Instagram">
                        <svg fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                        </svg>
                    </a>
                    <a href="#" class="social-icon" aria-label="YouTube">
                        <svg fill="currentColor" viewBox="0 0 24 24">
                            <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
                        </svg>
                    </a>
                </div>
            </div>

            <!-- Shop Column -->
            <div class="footer-column">
                <h3>Shop</h3>
                <ul>
                    <li><a href="marketplace.html">All Products</a></li>
                    <li><a href="marketplace.html?category=electronics">Electronics</a></li>
                    <li><a href="marketplace.html?category=fashion">Fashion</a></li>
                    <li><a href="marketplace.html?category=home">Home & Garden</a></li>
                    <li><a href="marketplace.html?category=sports">Sports</a></li>
                </ul>
            </div>

            <!-- Sell Column -->
            <div class="footer-column">
                <h3>Sell</h3>
                <ul>
                    <li><a href="seller.html">Dashboard</a></li>
                    <li><a href="seller-registration.html">Start Selling</a></li>
                    <li><a href="seller-profile.html">Your Store</a></li>
                    <li><a href="orders.html">Orders</a></li>
                </ul>
            </div>

            <!-- Account Column -->
            <div class="footer-column">
                <h3>Account</h3>
                <ul>
                    <li><a href="auth.html">Sign In</a></li>
                    <li><a href="profile.html">My Profile</a></li>
                    <li><a href="orders.html">My Orders</a></li>
                    <li><a href="cart.html">Cart</a></li>
                </ul>
            </div>

            <!-- Support Column -->
            <div class="footer-column">
                <h3>Support</h3>
                <ul>
                    <li><a href="index.html">Help Center</a></li>
                    <li><a href="index.html">Contact Us</a></li>
                    <li><a href="index.html">Shipping Info</a></li>
                    <li><a href="index.html">Returns</a></li>
                </ul>
            </div>
        </div>

        <!-- Footer Bottom: Copyright & Legal -->
        <div class="footer-bottom">
            <div class="footer-copyright">
                &copy; 2025 London Star Marketplace. All rights reserved.
            </div>
            <div class="footer-legal-links">
                <a href="index.html">Privacy Policy</a>
                <span>â€¢</span>
                <a href="index.html">Terms of Service</a>
                <span>â€¢</span>
                <a href="index.html">Cookie Policy</a>
            </div>
        </div>

        <!-- Parent Company Section -->
        <div class="footer-parent">
            <div class="footer-parent-label">A Subsidiary Of</div>
            <img src="images/logols.png" alt="London Star Records" class="footer-parent-logo">
        </div>
    </div>
</footer>

<!-- Premium UI Components -->
<script src="js/skeleton-loader.js"></script>
<script src="js/image-loader.js"></script>
<script src="js/rating-component.js"></script>
<script src="js/ripple.js"></script>

<!-- Vercel Analytics -->
<script defer src="/_vercel/insights/script.js"></script>
</body>
</html>
